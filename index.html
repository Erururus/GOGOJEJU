<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f3f4f6" media="(prefers-color-scheme: light)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Jeju Travel (V14.1 ä¿®å¾©ç‰ˆ)</title>
    
    <link rel="icon" type="image/png" href="icon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body { 
            background-color: #f3f4f6; 
            font-family: "Zen Maru Gothic", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            color: #374151; 
            letter-spacing: 0.03em;
            overscroll-behavior-y: none;
            overflow: hidden;
            height: 100%;
            width: 100%;
            position: fixed;
        }

        input, select, textarea { font-size: 16px !important; }

        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out; }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: calc(1.5rem + env(safe-area-inset-bottom));
        }
        
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#f87171' } } } }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Crash:", error); }
            resetData = () => {
                if(confirm("é€™å°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼ˆä¿®å¾©ç™½å±å•é¡Œï¼‰ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                    localStorage.clear();
                    window.location.reload();
                }
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-screen flex flex-col items-center justify-center p-8 text-center bg-gray-50">
                            <div className="bg-white p-6 rounded-3xl shadow-xl border-2 border-red-100 max-w-sm">
                                <h1 className="text-xl font-bold text-gray-800 mb-2">ç™¼ç”ŸéŒ¯èª¤</h1>
                                <button onClick={this.resetData} className="bg-red-500 text-white px-6 py-3 rounded-xl font-bold w-full mb-3">æ¸…é™¤è³‡æ–™ä¸¦ä¿®å¾©</button>
                                <button onClick={() => window.location.reload()} className="text-gray-400 text-xs underline">é‡æ–°æ•´ç†</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        const Icon = ({ name, size = 20, color = "currentColor", className="", strokeWidth=2 }) => {
            useEffect(() => { lucide.createIcons(); }, [name]); 
            return <i data-lucide={name} width={size} height={size} stroke={color} stroke-width={strokeWidth} className={className}></i>;
        };

        const formatDateTime24h = (isoString) => {
            if (!isoString) return '';
            const d = new Date(isoString);
            if (isNaN(d.getTime())) return ''; // é˜²æ­¢ç„¡æ•ˆæ—¥æœŸ
            const pad = (n) => n.toString().padStart(2, '0');
            return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        };

        const resizeImage = (file, maxWidth = 600) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.4); 
                        resolve(dataUrl);
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        const INITIAL_TRIP_DATA = {
            flights: [],
            hotels: [],
            quickLinks: [
                { label: "e-Arrival card", url: "https://www.e-arrivalcard.go.kr/portal/main/index.do", icon: "qr-code", color: "text-blue-500" },
                { label: "è¡Œç¨‹Naver Map", url: "https://naver.me/GPlHgkhf", icon: "map", color: "text-green-500" },
                { label: "åº—å®¶Naver Map", url: "https://naver.me/5L7Gh8hQ", icon: "store", color: "text-orange-500" }
            ]
        };

        const INITIAL_ITINERARY = [];
        const INITIAL_MEMOS = [];

        const CATEGORIES = [
            { id: 'food', name: 'é£Ÿ', color: 'bg-orange-600' }, 
            { id: 'clothing', name: 'è¡£', color: 'bg-violet-500' },
            { id: 'housing', name: 'ä½', color: 'bg-amber-400' }, 
            { id: 'transport', name: 'è¡Œ', color: 'bg-green-600' },
            { id: 'education', name: 'è‚²', color: 'bg-blue-500' }, 
            { id: 'fun', name: 'æ¨‚', color: 'bg-pink-500' },
            { id: 'agent', name: 'ä»£', color: 'bg-stone-600' }, 
            { id: 'gift', name: 'ç¦®', color: 'bg-rose-500' }, 
            { id: 'other', name: 'å®ƒ', color: 'bg-slate-700' },
        ];

        const PAYMENT_METHODS = ['ä¿¡ç”¨å¡', 'éŸ“å¹£ç¾é‡‘', 'WOWPASS', 'å°ç£Pay', 'LINE Pay', 'å°å¹£ç¾é‡‘'];
        const PAYERS = ['æ±', 'æ²™', 'å®ˆ'];

        const HomeView = ({ headerImage, setHeaderImage, onExport, onImport, tripData }) => {
            const handleHeaderUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try { const compressed = await resizeImage(file, 800); setHeaderImage(compressed); } 
                    catch (error) { alert("åœ–ç‰‡è™•ç†å¤±æ•—"); }
                }
            };
            const data = tripData || INITIAL_TRIP_DATA;

            return (
                <div className="h-full flex flex-col overflow-y-auto no-scrollbar safe-top">
                    <div className="space-y-4 pb-28">
                        <div className="w-full h-48 bg-gray-200 rounded-b-3xl overflow-hidden relative shadow-md group shrink-0">
                            <img src={headerImage || "https://i.meee.com.tw/rESnBG4.jpg"} className="w-full h-full object-cover" />
                            <div className="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
                            <h1 className="absolute bottom-4 left-4 text-white text-2xl font-bold drop-shadow-md">Jeju Island 2026 ğŸŠ</h1>
                            <label className="absolute bottom-3 right-3 bg-black/30 backdrop-blur-md p-2 rounded-full cursor-pointer hover:bg-black/50 transition-colors"><Icon name="camera" size={20} className="text-white" /><input type="file" accept="image/*" onChange={handleHeaderUpload} className="hidden" /></label>
                        </div>
                        <div className="px-4 space-y-4">
                            <div className="grid grid-cols-3 gap-3">
                                {data.quickLinks.map((link, i) => (
                                    <a key={i} href={link.url} target="_blank" className="bg-white p-3 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform">
                                        <Icon name={link.icon} className={link.color} size={28} />
                                        <span className={`${link.color} font-bold text-[11px] text-center leading-tight`}>{link.label}</span>
                                    </a>
                                ))}
                            </div>
                            <div className="bg-white rounded-2xl p-3 shadow-sm">
                                <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2"><Icon name="plane" size={18} /> èˆªç­è³‡è¨Š</h3>
                                {(data.flights || []).length === 0 ? <div className="text-center py-4 text-gray-400 text-xs">å°šç„¡èˆªç­è³‡æ–™ï¼Œè«‹åŒ¯å…¥ JSON</div> : <div className="space-y-2">{data.flights.map((f, i) => <div key={i} className="bg-gray-50 p-2.5 rounded-xl border border-gray-100"><div className="flex items-center gap-2 mb-1"><span className="text-xs font-bold px-2 py-0.5 rounded bg-gray-200 text-gray-800">{f.type}</span><span className="font-bold text-gray-700 text-sm">({f.code})</span><span className="text-sm text-gray-500">{f.date}</span></div><div className="text-gray-800 font-bold font-mono pl-1 text-sm">{f.detail}</div></div>)}</div>}
                            </div>
                            <div className="bg-white rounded-2xl p-3 shadow-sm">
                                <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2"><Icon name="bed-double" size={18} /> ä½å®¿è³‡è¨Š</h3>
                                {(data.hotels || []).length === 0 ? <div className="text-center py-4 text-gray-400 text-xs">å°šç„¡ä½å®¿è³‡æ–™ï¼Œè«‹åŒ¯å…¥ JSON</div> : <div className="space-y-2">{data.hotels.map((h, i) => <div key={i} className="bg-gray-50 p-2.5 rounded-xl border border-gray-100"><div className="flex items-center gap-2 mb-1"><span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-purple-100 text-purple-700 whitespace-nowrap">{h.date}</span><span className="font-bold text-gray-800 text-sm truncate">{h.name}</span></div><div className="flex justify-between items-end gap-2 pl-1"><div className="text-gray-500 text-[10px] leading-tight line-clamp-1 font-mono font-bold tracking-tight bg-gray-100 px-2 py-0.5 rounded">{h.address}</div><a href={h.map} target="_blank" className="text-green-500 text-[10px] font-bold flex items-center gap-1 shrink-0 whitespace-nowrap bg-white px-1.5 py-0.5 rounded border border-green-200 hover:bg-green-50"><Icon name="map-pin" size={10} /> Naver</a></div></div>)}</div>}
                            </div>
                            <div className="bg-white rounded-2xl p-4 shadow-sm mt-4">
                                 <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2"><Icon name="database" size={18} /> æ•¸æ“šé‚„åŸ</h3>
                                 <div className="flex gap-3">
                                    <button onClick={onExport} className="flex-1 bg-gray-50 border border-gray-200 text-gray-600 py-2 rounded-xl text-xs font-bold flex items-center justify-center gap-2 active:bg-gray-100"><Icon name="download" size={14}/> åŒ¯å‡ºå‚™ä»½</button>
                                    <label className="flex-1 bg-gray-50 border border-gray-200 text-gray-600 py-2 rounded-xl text-xs font-bold flex items-center justify-center gap-2 active:bg-gray-100 cursor-pointer">
                                        <Icon name="upload" size={14}/> åŒ¯å…¥è¡Œç¨‹
                                        <input type="file" accept=".json" onChange={onImport} className="hidden" />
                                    </label>
                                 </div>
                                 <p className="text-[10px] text-gray-400 mt-2 text-center">ä¸‹è¼‰å¾Œï¼Œè«‹åŒ¯å…¥ JSON æª”ä»¥è¼‰å…¥è¡Œç¨‹ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ItineraryView = ({ itineraryData, setItineraryData }) => {
            const [selectedDate, setSelectedDate] = useState("2026-01-10");
            const [isEditMode, setIsEditMode] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [weather, setWeather] = useState({ temp: '--', max: '--', min: '--', feels: '--', humidity: '--', code: 0, loading: false, location: '' });
            
            const weekDays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dates = useMemo(() => { const arr = []; let curr = new Date("2026-01-10"); for(let i=0; i<6; i++) { arr.push(new Date(curr)); curr.setDate(curr.getDate()+1); } return arr; }, []);
            const hours = [...Array(24).keys()].map(i => i.toString().padStart(2, '0'));
            const minutes = [...Array(60).keys()].map(i => i.toString().padStart(2, '0'));
            const safeItinerary = Array.isArray(itineraryData) ? itineraryData : [];
            const daysEvents = safeItinerary.filter(i => i.date === selectedDate).sort((a,b)=>a.time.localeCompare(b.time));

            useEffect(() => {
                const fetchWeather = async () => {
                    setWeather(prev => ({...prev, loading: true}));
                    let lat = 33.4996, lon = 126.5312, locName = 'æ¿Ÿå·å¸‚'; 
                    if (selectedDate === '2026-01-12' || selectedDate === '2026-01-11') { lat = 33.2541; lon = 126.5601; locName = 'è¥¿æ­¸æµ¦'; }
                    const cacheKey = `weather_jeju_${selectedDate}`;
                    const cached = localStorage.getItem(cacheKey);
                    if (cached) setWeather(JSON.parse(cached));
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=Asia%2FSeoul`);
                        const data = await res.json();
                        if (data.current && data.daily) {
                            const newWeather = { temp: Math.round(data.current.temperature_2m), max: Math.round(data.daily.temperature_2m_max[0]), min: Math.round(data.daily.temperature_2m_min[0]), feels: Math.round(data.current.apparent_temperature), humidity: data.current.relative_humidity_2m, code: data.current.weather_code, location: locName, loading: false };
                            setWeather(newWeather);
                            localStorage.setItem(cacheKey, JSON.stringify(newWeather));
                        }
                    } catch (e) { setWeather(prev => ({...prev, loading: false})); }
                };
                fetchWeather();
            }, [selectedDate]);

            const getTypeStyle = (type) => {
                switch(type) {
                    case 'hotel': return { bg:'bg-purple-100', c:'text-purple-600', i:'bed' };
                    case 'move': return { bg:'bg-green-100', c:'text-green-600', i:'car' };
                    case 'shopping': return { bg:'bg-teal-100', c:'text-teal-600', i:'shopping-bag' };
                    case 'food': return { bg:'bg-orange-100', c:'text-orange-600', i:'utensils' };
                    case 'spot': default: return { bg:'bg-blue-100', c:'text-blue-600', i:'map-pin' };
                }
            };
            const handleSave = (e) => {
                e.preventDefault(); const form = e.target;
                const combinedTime = `${form.hour.value}:${form.minute.value}`;
                const newItem = { id: editingItem?.id || Date.now() + Math.random().toString(36).substr(2, 9), date: selectedDate, time: combinedTime, type: form.type.value, title: form.title.value, note: form.note.value };
                setItineraryData(prev => editingItem?.id ? prev.map(i => i.id === newItem.id ? newItem : i) : [...prev, newItem]);
                setEditingItem(null);
            };
            const exportItineraryCSV = () => {
                const sortedData = [...safeItinerary].sort((a, b) => (a.date !== b.date) ? a.date.localeCompare(b.date) : a.time.localeCompare(b.time));
                const csv = "\uFEFFæ—¥æœŸ,æ™‚é–“,é¡åˆ¥,åœ°é»/é …ç›®,å‚™è¨»\n" + sortedData.map(item => `${item.date},${item.time},${item.type},${item.title},${item.note||''}`).join("\n");
                const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = `JejuTrip_Itinerary.csv`; link.click();
            };

            return (
                <div className="h-full flex flex-col safe-top">
                    <div className="bg-white/90 backdrop-blur-sm shadow-sm pt-4 pb-2 px-2 sticky top-0 z-20 shrink-0"><div className="flex overflow-x-auto no-scrollbar gap-3 px-2">{dates.map((d, i) => <button key={i} onClick={() => setSelectedDate(d.toISOString().split('T')[0])} className={`flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl transition-all ${d.toISOString().split('T')[0] === selectedDate ? 'bg-orange-400 text-white shadow-md scale-105' : 'bg-gray-50 text-gray-400'}`}>
                        <span className={`text-[10px] font-bold ${d.toISOString().split('T')[0] === selectedDate ? 'text-orange-100' : 'text-gray-400'}`}>DAY {i+1}</span>
                        <span className="text-lg font-bold leading-none my-0.5">{d.getMonth()+1}/{d.getDate()}</span>
                        <span className="text-[10px] font-medium tracking-wider">{weekDays[d.getDay()]}</span>
                    </button>)}</div></div>
                    <div className="p-4 flex-1 overflow-y-auto pb-28">
                        <div className="bg-white border border-blue-100 rounded-2xl p-3 shadow-sm mb-4 flex items-center gap-4"><div className="flex items-center gap-2 pl-2"><Icon name={weather.code > 3 ? "cloud-rain" : "cloud-sun"} size={32} className="text-blue-500" /><span className="text-3xl font-bold text-gray-800 tracking-tight">{weather.temp}Â°</span></div><div className="w-px h-8 bg-gray-100"></div><div className="flex-1 flex flex-col justify-center gap-0.5 text-xs text-gray-500"><div className="flex items-center gap-1 font-bold text-gray-700"><Icon name="map-pin" size={10} className="text-orange-400"/> {weather.location}</div><div>H:{weather.max}Â° L:{weather.min}Â°</div><div className="flex items-center gap-2"><span>é«”æ„Ÿ {weather.feels}Â°</span><span className="text-gray-200">|</span><span className="flex items-center gap-1"><Icon name="droplets" size={10} className="text-blue-300"/> {weather.humidity}%</span></div></div></div>
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-700">è¡Œç¨‹ç¸½è¦½</h3><div className="flex gap-2"><button onClick={exportItineraryCSV} className="text-xs px-3 py-1 rounded-full border bg-white text-gray-500 flex items-center gap-1 active:scale-95"><Icon name="file-down" size={14} /> åŒ¯å‡º</button><button onClick={() => setIsEditMode(!isEditMode)} className={`text-xs px-3 py-1 rounded-full border ${isEditMode ? 'bg-orange-400 text-white' : 'bg-white text-gray-500'}`}>{isEditMode ? 'å®Œæˆ' : 'ç·¨è¼¯'}</button></div></div>
                        <div className="space-y-4 relative pl-2">
                             {daysEvents.length === 0 && <div className="flex flex-col items-center justify-center py-10 text-gray-300"><Icon name="coffee" size={48} strokeWidth={1.5} /><span className="text-sm mt-2">ä»Šå¤©æ²’æœ‰è¡Œç¨‹ï¼Œæ”¾é¬†ä¸€ä¸‹å§</span></div>}
                            {daysEvents.map((item, idx) => {
                                const style = getTypeStyle(item.type);
                                const query = item.mapKeyword || item.title;
                                const mapSearchUrl = `https://map.naver.com/v5/search/${encodeURIComponent(query)}`;
                                return (
                                    <div key={item.id} className="flex gap-3 relative">
                                        <div className="flex flex-col items-center w-12 shrink-0 relative">
                                            {idx !== daysEvents.length - 1 && <div className="absolute top-8 bottom-[-24px] w-0.5 bg-gray-200 -z-0"></div>}
                                            <span className="text-[11px] font-bold text-gray-500 mb-1 font-mono tracking-tight">{item.time}</span>
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md z-10 ${style.bg.replace('bg-', 'bg-').replace('100', '500')}`}><Icon name={style.i} size={20} /></div>
                                        </div>
                                        <div className="flex-1 pl-2 pb-6 min-w-0">
                                            <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center active:scale-[0.98] transition-transform">
                                                <div className="flex-1 min-w-0 pr-2"><h4 className={`font-bold text-base truncate ${style.c}`}>{item.title}</h4>{item.note && <p className="text-xs text-gray-500 mt-0.5 whitespace-pre-wrap break-words leading-relaxed font-zen">{item.note}</p>}</div>
                                                <div className="flex items-center gap-2 shrink-0">{isEditMode ? (<><button onClick={()=>setEditingItem(item)} className="p-2 bg-blue-50 rounded-full text-blue-400"><Icon name="edit-2" size={14}/></button><button onClick={()=>{if(confirm('åˆªé™¤?'))setItineraryData(p=>p.filter(x=>x.id!==item.id))}} className="p-2 bg-red-50 rounded-full text-red-400"><Icon name="trash-2" size={14}/></button></>) : <a href={mapSearchUrl} target="_blank" className="text-green-500 hover:text-green-600 transition-colors bg-green-50 p-2 rounded-full"><Icon name="navigation" size={16} /></a>}</div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            {isEditMode && <button onClick={() => setEditingItem({id:null, time:'12:00', type:'spot', title:'', note:''})} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 flex justify-center items-center gap-2 hover:bg-gray-50 mt-4"><Icon name="plus" /> æ–°å¢è¡Œç¨‹</button>}
                        </div>
                    </div>
                    {editingItem && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><form onSubmit={handleSave} className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-fade-in-up"><h3 className="font-bold text-lg mb-4 text-center">{editingItem.id?'ç·¨è¼¯':'æ–°å¢'}è¡Œç¨‹</h3><div className="space-y-3"><div className="grid grid-cols-5 gap-2"><div className="col-span-3 flex gap-1 items-center bg-gray-50 p-3 rounded-xl border"><select name="hour" defaultValue={editingItem.time.split(':')[0]} className="bg-transparent outline-none text-center font-bold text-lg w-full appearance-none text-gray-700">{hours.map(h=><option key={h} value={h}>{h}</option>)}</select><span className="font-bold text-gray-400">:</span><select name="minute" defaultValue={editingItem.time.split(':')[1]} className="bg-transparent outline-none text-center font-bold text-lg w-full appearance-none text-gray-700">{minutes.map(m=><option key={m} value={m}>{m}</option>)}</select></div><select name="type" defaultValue={editingItem.type} className="col-span-2 bg-gray-50 p-3 rounded-xl border w-full text-sm font-bold text-gray-600"><option value="spot">æ™¯é»</option><option value="move">äº¤é€š/ç§Ÿè»Š</option><option value="shopping">è³¼ç‰©</option><option value="food">ç¾é£Ÿ</option><option value="hotel">ä½å®¿</option></select></div><input type="text" name="title" placeholder="åœ°é»åç¨±" defaultValue={editingItem.title} className="w-full bg-gray-50 p-3 rounded-xl border" required /><input type="text" name="note" placeholder="å‚™è¨»" defaultValue={editingItem.note} className="w-full bg-gray-50 p-3 rounded-xl border" /></div><div className="grid grid-cols-2 gap-3 mt-6"><button type="button" onClick={()=>setEditingItem(null)} className="py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button type="submit" className="py-3 bg-orange-400 rounded-xl font-bold text-white">å„²å­˜</button></div></form></div>}
                </div>
            );
        };
        const ConverterView = () => {
            const [rate, setRate] = useState(0.024); const [input, setInput] = useState("0"); const [mode, setMode] = useState("KRW"); 
            const [showRateModal, setShowRateModal] = useState(false); const [newRate, setNewRate] = useState(rate);
            const [prevValue, setPrevValue] = useState(null); const [op, setOp] = useState(null); const [waiting, setWaiting] = useState(false);

            const calculate = (val) => { if(val==="")return"0"; return mode==="KRW"?(parseFloat(val)*rate).toFixed(0):(parseFloat(val)/rate).toFixed(0); };
            const handleNum = (n) => { if(waiting){setInput(String(n));setWaiting(false);}else{setInput(prev=>prev==="0"?String(n):prev+n);} };
            const handleOp = (nextOp) => { const current=parseFloat(input); if(prevValue!=null){let res=current; if(op==='+')res=prevValue+current; if(op==='-')res=prevValue-current; if(op==='Ã—')res=prevValue*current; if(op==='Ã·')res=prevValue/current; setInput(String(res)); setPrevValue(res);}else{setPrevValue(current);} setOp(nextOp); setWaiting(true); };
            const handleEqual = () => { if(op&&prevValue!=null){const current=parseFloat(input); let res=current; if(op==='+')res=prevValue+current; if(op==='-')res=prevValue-current; if(op==='Ã—')res=prevValue*current; if(op==='Ã·')res=prevValue/current; setInput(String(res)); setPrevValue(null); setOp(null); setWaiting(true);} };
            const handleClear = () => { setInput("0"); setPrevValue(null); setOp(null); setWaiting(false); };
            const handleBS = () => { if(waiting)return; setInput(prev=>prev.length>1?prev.slice(0,-1):"0"); };
            const getHistoryDisplay = () => op&&prevValue!=null ? `${prevValue} ${op}` : "";
            const saveRate = () => { setRate(parseFloat(newRate)); setShowRateModal(false); };

            const btnClass = "h-16 rounded-2xl font-bold text-xl shadow-sm active:scale-95 transition-transform flex items-center justify-center";
            const numBtn = `${btnClass} bg-white text-gray-700`; const opBtn = `${btnClass} bg-orange-50 text-orange-500`; const eqBtn = `${btnClass} bg-orange-400 text-white row-span-2 shadow-md`;

            return (
                <div className="h-full flex flex-col p-4 bg-gray-50 pb-28 relative overflow-y-auto no-scrollbar safe-top">
                    <div className="flex justify-end mb-4"><button onClick={()=>setShowRateModal(true)} className="flex items-center gap-2 bg-white px-3 py-2 rounded-full shadow-sm text-xs font-bold text-gray-500 active:scale-95 transition-transform border border-gray-100"><Icon name="sliders-horizontal" size={14} className="text-orange-400" /><span>åŒ¯ç‡: {rate}</span></button></div>
                    <div className="bg-white rounded-3xl p-6 shadow-sm mb-4 flex-1 flex flex-col justify-center space-y-6">
                        <div onClick={()=>setMode("KRW")} className={`cursor-pointer transition-all ${mode==='KRW'?'opacity-100 scale-105':'opacity-50'}`}><div className="text-sm text-gray-500 mb-1">éŸ“å…ƒ (KRW)</div><div className="flex justify-between items-end"><div className={`text-4xl font-bold ${mode==='KRW'?'text-orange-400':'text-gray-800'}`}>{mode==='KRW'?input:calculate(input)}</div>{mode==='KRW'&&<div className="text-sm text-gray-400 font-medium mb-1 font-mono">{getHistoryDisplay()}</div>}</div></div>
                        <div className="w-full h-px bg-gray-100"></div>
                        <div onClick={()=>setMode("TWD")} className={`cursor-pointer transition-all ${mode==='TWD'?'opacity-100 scale-105':'opacity-50'}`}><div className="text-sm text-gray-500 mb-1">å°å¹£ (TWD)</div><div className="flex justify-between items-end"><div className={`text-4xl font-bold ${mode==='TWD'?'text-orange-400':'text-gray-800'}`}>{mode==='TWD'?input:calculate(input)}</div>{mode==='TWD'&&<div className="text-sm text-gray-400 font-medium mb-1 font-mono">{getHistoryDisplay()}</div>}</div></div>
                    </div>
                    <div className="grid grid-cols-4 gap-3 grid-rows-5 h-[420px] shrink-0">
                        <button onClick={handleClear} className={opBtn}>C</button><button onClick={()=>handleOp('Ã·')} className={opBtn}>Ã·</button><button onClick={()=>handleOp('Ã—')} className={opBtn}>Ã—</button><button onClick={handleBS} className={opBtn}><Icon name="delete" /></button>
                        <button onClick={()=>handleNum(7)} className={numBtn}>7</button><button onClick={()=>handleNum(8)} className={numBtn}>8</button><button onClick={()=>handleNum(9)} className={numBtn}>9</button><button onClick={()=>handleOp('-')} className={opBtn}>-</button>
                        <button onClick={()=>handleNum(4)} className={numBtn}>4</button><button onClick={()=>handleNum(5)} className={numBtn}>5</button><button onClick={()=>handleNum(6)} className={numBtn}>6</button><button onClick={()=>handleOp('+')} className={opBtn}>+</button>
                        <button onClick={()=>handleNum(1)} className={numBtn}>1</button><button onClick={()=>handleNum(2)} className={numBtn}>2</button><button onClick={()=>handleNum(3)} className={numBtn}>3</button><button onClick={handleEqual} className={`${eqBtn} row-span-2 text-2xl`}>=</button>
                        <button onClick={()=>handleNum(0)} className={`${numBtn} col-span-2`}>0</button><button onClick={()=>handleNum('.')} className={numBtn}>.</button>
                    </div>
                    {showRateModal && <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6"><div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-fade-in-scale"><h3 className="font-bold text-lg text-center mb-4 text-gray-700">è¨­å®šåŒ¯ç‡</h3><div className="bg-gray-50 p-4 rounded-2xl flex items-center justify-center gap-2 mb-6 border border-gray-100"><span className="text-sm font-bold text-gray-400">1 KRW =</span><input type="number" step="0.001" value={newRate} onChange={e=>setNewRate(e.target.value)} className="w-20 bg-transparent text-2xl font-bold text-center text-gray-800 outline-none border-b-2 border-orange-200 focus:border-orange-400 transition-colors" autoFocus /><span className="text-sm font-bold text-gray-400">TWD</span></div><div className="grid grid-cols-2 gap-3"><button onClick={()=>setShowRateModal(false)} className="py-3 bg-gray-100 rounded-xl font-bold text-gray-500 active:bg-gray-200 transition-colors">å–æ¶ˆ</button><button onClick={saveRate} className="py-3 bg-orange-400 rounded-xl font-bold text-white shadow-lg shadow-orange-200 active:scale-95 transition-all">ç¢ºå®š</button></div></div></div>}
                </div>
            );
        };

        const AccountingView = ({ expenses, setExpenses, shoppingList, setShoppingList, paymentMemos, setPaymentMemos }) => {
            const [viewMode, setViewMode] = useState('expenses'); 
            const [showModal, setShowModal] = useState(false);
            const [editingExp, setEditingExp] = useState(null);
            const [form, setForm] = useState({ amount:'', currency:'KRW', category:'food', item:'', payment:'ä¿¡ç”¨å¡', payer:'æ±', note:'' });
            
            // å®‰å…¨æ€§ä¿®æ­£ï¼šç¢ºä¿å®‰å…¨è¨ˆç®—
            const safeExpenses = Array.isArray(expenses) ? expenses : [];
            const totalKRW = safeExpenses.filter(e => e && e.currency === 'KRW').reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
            const totalTWD = safeExpenses.filter(e => e && e.currency === 'TWD').reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
            
            const safeShoppingList = Array.isArray(shoppingList) ? shoppingList : [];
            const safeMemos = Array.isArray(paymentMemos) ? paymentMemos : [];

            const openModal = (exp = null) => { if(exp) { setEditingExp(exp); setForm(exp); } else { setEditingExp(null); setForm({ amount:'', currency:'KRW', category:'food', item:'', payment:'ä¿¡ç”¨å¡', payer:'æ±', note:'' }); } setShowModal(true); };
            const submit = () => { 
                if(!form.amount || !form.item) return alert("è«‹è¼¸å…¥é‡‘é¡èˆ‡å“é …");
                const newExp = { ...form, id: editingExp ? editingExp.id : Date.now() + Math.random().toString(36).substr(2, 9), timestamp: editingExp ? editingExp.timestamp : new Date().toISOString() };
                setExpenses(prev => editingExp ? prev.map(e => e.id === newExp.id ? newExp : e) : [newExp, ...prev]); 
                setShowModal(false); 
            };
            const deleteExpense = () => { if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ")) { setExpenses(prev => prev.filter(e => e.id !== editingExp.id)); setShowModal(false); } };
            const exportExpensesCSV = () => {
                const csv = "\uFEFFæ™‚é–“,åˆ†é¡,å“é …,é‡‘é¡,å¹£åˆ¥,ä»˜æ¬¾æ–¹å¼,ä»˜æ¬¾äºº,å‚™è¨»\n" + 
                safeExpenses.map(e => `${formatDateTime24h(e.timestamp)},${CATEGORIES.find(c=>c.id===e.category)?.name || 'æœªåˆ†é¡'},${e.item},${e.amount},${e.currency},${e.payment},${e.payer},${e.note}`).join("\n");
                const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = `JejuTrip_Expenses_${new Date().toISOString().slice(0,10)}.csv`; link.click();
            };
            const formatMoney = (amount) => Number(amount).toLocaleString();

            const [showWishModal, setShowWishModal] = useState(false);
            const [wishForm, setWishForm] = useState({ name: '', image: null });
            const addWishItem = () => {
                if(!wishForm.name) return;
                setShoppingList(prev => [...prev, { id: Date.now() + Math.random().toString(36).substr(2, 9), name: wishForm.name, image: wishForm.image, bought: false }]);
                setShowWishModal(false); setWishForm({ name: '', image: null });
            };

            const deleteWishItem = (id) => { if(confirm("ç§»é™¤æ­¤é …ç›®ï¼Ÿ")) setShoppingList(prev => prev.filter(item => item.id !== id)); };
            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try { const compressed = await resizeImage(file); setWishForm(prev => ({ ...prev, image: compressed })); } 
                    catch (error) { alert("åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦"); }
                }
            };
            
            const [showMemoModal, setShowMemoModal] = useState(false);
            const [memoForm, setMemoForm] = useState({ id: null, title: '', content: '', image: null });
            const openMemoModal = (memo = null) => { if (memo) setMemoForm(memo); else setMemoForm({ id: null, title: '', content: '', image: null }); setShowMemoModal(true); };
            const submitMemo = () => {
                if (!memoForm.title) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");
                const newMemo = { ...memoForm, id: memoForm.id || Date.now() + Math.random().toString(36).substr(2, 9) };
                setPaymentMemos(prev => memoForm.id ? prev.map(m => m.id === newMemo.id ? newMemo : m) : [newMemo, ...prev]);
                setShowMemoModal(false);
            };
            const deleteMemo = () => { if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è¨˜ï¼Ÿ")) { setPaymentMemos(prev => prev.filter(m => m.id !== memoForm.id)); setShowMemoModal(false); } };
            const moveMemo = (index, direction) => {
                const newMemos = [...safeMemos];
                if (direction === -1 && index > 0) { [newMemos[index], newMemos[index - 1]] = [newMemos[index - 1], newMemos[index]]; } 
                else if (direction === 1 && index < newMemos.length - 1) { [newMemos[index], newMemos[index + 1]] = [newMemos[index + 1], newMemos[index]]; }
                setPaymentMemos(newMemos);
            };
            const handleMemoImageUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try { const compressed = await resizeImage(file); setMemoForm(prev => ({ ...prev, image: compressed })); } 
                    catch (error) { alert("åœ–ç‰‡è™•ç†å¤±æ•—"); }
                }
            };

            return (
                <div className="h-full flex flex-col bg-gray-50 pb-20 safe-top">
                    <div className="flex flex-col p-4 bg-gray-50 sticky top-0 z-10 gap-3">
                        <div className="flex justify-between items-center">
                            <h2 className="text-xl font-bold text-gray-800">è¨˜å¸³ä¸­å¿ƒ</h2>
                            <div className="flex gap-2">
                                {viewMode === 'expenses' && (
                                    <button onClick={exportExpensesCSV} className="w-8 h-8 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-500 shadow-sm"><Icon name="file-down" size={16}/></button>
                                )}
                                <button onClick={() => { if (viewMode === 'expenses') openModal(); else if (viewMode === 'wishlist') setShowWishModal(true); else openMemoModal(); }} className="w-8 h-8 flex items-center justify-center rounded-full bg-orange-400 text-white shadow-md"><Icon name="plus" size={18}/></button>
                            </div>
                        </div>
                        <div className="flex bg-gray-200 p-1 rounded-xl">
                            <button onClick={()=>setViewMode('expenses')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all ${viewMode==='expenses' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-500'}`}>æ”¯å‡ºç´€éŒ„</button>
                            <button onClick={()=>setViewMode('wishlist')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all ${viewMode==='wishlist' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-500'}`}>è³¼ç‰©æ¸…å–®</button>
                            <button onClick={()=>setViewMode('memo')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all ${viewMode==='memo' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-500'}`}>å„ªæƒ ç­†è¨˜</button>
                        </div>
                    </div>

                    {viewMode === 'expenses' && (
                        <div className="flex-1 flex flex-col overflow-y-auto pb-28">
                            <div className="px-4 grid grid-cols-2 gap-3 mb-4 shrink-0">
                                <div className="bg-white p-4 rounded-xl shadow-sm border-b-4 border-orange-400"><div className="text-xs text-gray-500 mb-1">ç¸½æ”¯å‡º (éŸ“å…ƒ)</div><div className="text-2xl font-bold text-gray-800 tracking-tight">{formatMoney(totalKRW)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow-sm border-b-4 border-orange-400"><div className="text-xs text-gray-500 mb-1">ç¸½æ”¯å‡º (å°å¹£)</div><div className="text-2xl font-bold text-gray-800 tracking-tight">{formatMoney(totalTWD)}</div></div>
                            </div>
                            <div className="px-4 space-y-3">
                                {safeExpenses.length===0 && (
                                    <div className="flex flex-col items-center justify-center py-10 text-gray-300">
                                        <Icon name="receipt" size={48} strokeWidth={1.5} />
                                        <span className="text-sm mt-2">é‚„æ²’æœ‰è¨˜å¸³å–”ï¼ŒæŒ‰ + æ–°å¢</span>
                                    </div>
                                )}
                                {safeExpenses.map(e => { 
                                    if (!e) return null; // é˜²å‘†
                                    const cat = CATEGORIES.find(c=>c.id===e.category) || CATEGORIES[0];
                                    const dateObj = new Date(e.timestamp);
                                    const dateStr = !isNaN(dateObj.getTime()) ? `${(dateObj.getMonth()+1)}/${dateObj.getDate()}` : '--/--';
                                    return (
                                        <div key={e.id} className="bg-white p-3 rounded-xl shadow-sm relative active:scale-[0.99] transition-transform flex flex-col gap-1 cursor-pointer" onClick={() => openModal(e)}>
                                            <div className="flex justify-between items-start">
                                                <div className="font-bold text-gray-800 text-base truncate pr-2 flex-1">{e.item}</div>
                                                <div className="font-bold text-orange-500 text-lg whitespace-nowrap">{formatMoney(e.amount)} <span className="text-xs font-normal text-gray-400">{e.currency}</span></div>
                                            </div>
                                            <div className="flex items-center gap-2 overflow-x-auto no-scrollbar text-[10px] text-gray-500">
                                                <span className={`px-2 py-0.5 rounded-full text-white ${cat.color} shrink-0`}>{cat.name}</span>
                                                <span className="shrink-0">{dateStr}</span>
                                                <div className="w-px h-3 bg-gray-200 shrink-0"></div>
                                                <span className="shrink-0">{e.payment}</span>
                                                <span className="px-1.5 py-0.5 bg-indigo-50 text-indigo-500 rounded font-bold shrink-0">{e.payer}</span>
                                                {e.note && <span className="text-gray-400 truncate max-w-[80px] italic">Â· {e.note}</span>}
                                            </div>
                                            <div className="absolute bottom-3 right-3 text-gray-300">
                                                <Icon name="chevron-right" size={16}/>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    )}

                    {viewMode === 'wishlist' && (
                        <div className="px-4 grid grid-cols-2 gap-3 overflow-y-auto flex-1 content-start pb-28">
                            {safeShoppingList.length === 0 && (
                                <div className="col-span-2 flex flex-col items-center justify-center py-10 text-gray-300">
                                    <Icon name="shopping-bag" size={48} strokeWidth={1.5} />
                                    <span className="text-sm mt-2">è³¼ç‰©æ¸…å–®æ˜¯ç©ºçš„</span>
                                </div>
                            )}
                            {safeShoppingList.map(item => (
                                <div key={item.id} className="bg-white rounded-2xl shadow-sm overflow-hidden flex flex-col relative">
                                    <div className="aspect-square bg-gray-100 flex items-center justify-center overflow-hidden relative group">
                                        {item.image ? (
                                            <img src={item.image} alt={item.name} className="w-full h-full object-cover" />
                                        ) : (
                                            <Icon name="image" size={32} className="text-gray-300" />
                                        )}
                                    </div>
                                    <div className="px-3 py-2.5 flex items-center justify-between bg-white">
                                        <div className="font-bold text-gray-800 text-sm truncate flex-1 pr-2">{item.name}</div>
                                        <button onClick={() => deleteWishItem(item.id)} className="text-gray-300 hover:text-orange-400 p-1 -mr-1 rounded-full hover:bg-orange-50 transition-colors shrink-0">
                                            <Icon name="trash-2" size={16}/>
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {viewMode === 'memo' && (
                        <div className="px-4 space-y-4 overflow-y-auto flex-1 pb-28">
                             {safeMemos.length === 0 && (
                                <div className="flex flex-col items-center justify-center py-10 text-gray-300">
                                    <Icon name="sticky-note" size={48} strokeWidth={1.5} />
                                    <span className="text-sm mt-2">æ²’æœ‰ç­†è¨˜</span>
                                </div>
                             )}
                             {safeMemos.map((memo, idx) => (
                                 <div key={memo.id} onClick={() => openMemoModal(memo)} className="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-yellow-400 active:scale-[0.99] transition-transform cursor-pointer relative group">
                                     <div className="flex justify-between items-center mb-2 border-b pb-2 border-gray-100">
                                        <div className="flex items-center gap-3">
                                            {memo.image && <img src={memo.image} className="w-16 h-10 object-cover rounded-md border border-gray-200" />}
                                            <h3 className="font-bold text-gray-800 text-lg">{memo.title}</h3>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {idx > 0 && <button onClick={(e) => { e.stopPropagation(); moveMemo(idx, -1); }} className="p-1 text-gray-300 hover:text-gray-500 hover:bg-gray-100 rounded"><Icon name="arrow-up" size={14} /></button>}
                                            {idx < safeMemos.length - 1 && <button onClick={(e) => { e.stopPropagation(); moveMemo(idx, 1); }} className="p-1 text-gray-300 hover:text-gray-500 hover:bg-gray-100 rounded"><Icon name="arrow-down" size={14} /></button>}
                                            <div className="w-px h-3 bg-gray-200 mx-1"></div>
                                            <Icon name="edit-2" size={14} className="text-gray-300" />
                                        </div>
                                     </div>
                                     <div className="text-sm text-gray-600 whitespace-pre-wrap leading-relaxed font-zen bg-gray-50 p-2 rounded-lg">{memo.content}</div>
                                 </div>
                             ))}
                        </div>
                    )}

                    {showModal && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center">
                            <div className="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 h-[85vh] sm:h-auto overflow-y-auto animate-fade-in-up flex flex-col">
                                <div className="flex justify-between items-center mb-1"><h3 className="text-xl font-bold text-gray-800">æ–°å¢æ”¯å‡º</h3><button onClick={()=>setShowModal(false)} className="text-gray-400"><Icon name="x" size={24} /></button></div>
                                <div className="text-xs text-gray-400 mb-6">è¨˜å¸³æ™‚é–“: {new Date().toLocaleString()}</div>
                                <div className="space-y-5 flex-1">
                                    <div className="flex gap-3">
                                        <div className="flex-1"><label className="text-xs text-gray-500 mb-1 block">é‡‘é¡</label><input type="number" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})} className="w-full border border-gray-200 rounded-lg p-3 text-lg font-bold outline-none focus:border-orange-400" placeholder="0" autoFocus /></div>
                                        <div className="w-24"><label className="text-xs text-gray-500 mb-1 block">å¹£åˆ¥</label><select value={form.currency} onChange={e=>setForm({...form, currency:e.target.value})} className="w-full border border-gray-200 rounded-lg p-3 text-lg font-bold outline-none bg-white"><option value="KRW">KRW</option><option value="TWD">TWD</option></select></div>
                                    </div>
                                    <div><label className="text-xs text-gray-500 mb-1 block">å“é …</label><input type="text" value={form.item} onChange={e=>setForm({...form, item:e.target.value})} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:border-orange-400" placeholder="ä¾‹å¦‚: é»‘è±¬è‚‰ç‡’çƒ¤" /></div>
                                    <div>
                                        <label className="text-xs text-gray-500 mb-2 block">åˆ†é¡</label>
                                        <div className="flex flex-wrap gap-3">{CATEGORIES.map(c => <button key={c.id} onClick={()=>setForm({...form, category:c.id})} className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all shadow-sm ${form.category===c.id ? `${c.color} text-white scale-110` : 'bg-gray-50 text-gray-400 border border-gray-100'}`}>{c.name}</button>)}</div>
                                    </div>
                                    <div><label className="text-xs text-gray-500 mb-2 block">ä»˜æ¬¾æ–¹å¼</label><div className="flex flex-wrap gap-2">{PAYMENT_METHODS.map(p => <button key={p} onClick={()=>setForm({...form, payment:p})} className={`px-4 py-1.5 rounded-full text-xs font-medium transition-colors border ${form.payment===p ? 'border-orange-400 text-orange-400 bg-orange-50' : 'border-gray-100 bg-gray-50 text-gray-400'}`}>{p}</button>)}</div></div>
                                    <div><label className="text-xs text-gray-500 mb-2 block">ä»˜æ¬¾äºº</label><div className="flex gap-2">{PAYERS.map(p => <button key={p} onClick={()=>setForm({...form, payer:p})} className={`px-4 py-1.5 rounded-full text-xs font-bold transition-colors ${form.payer===p ? 'bg-orange-400 text-white' : 'bg-gray-100 text-gray-400'}`}>{p}</button>)}</div></div>
                                    <div><label className="text-xs text-gray-500 mb-1 block">å‚™è¨»</label><textarea value={form.note} onChange={e=>setForm({...form, note:e.target.value})} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:border-orange-400 h-20 resize-none" placeholder="å‚™è¨»..." ></textarea></div>
                                </div>
                                <div className="mt-6 flex items-center justify-between">
                                    {editingExp ? <button onClick={deleteExpense} className="flex items-center gap-1 text-red-400 px-4 py-3 rounded-xl hover:bg-red-50 transition-colors"><Icon name="trash-2" size={20} /> <span className="text-sm font-bold">åˆªé™¤</span></button> : <div></div>}
                                    <button onClick={submit} className="bg-orange-400 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-orange-200 active:scale-95 transition-transform flex items-center gap-2"><Icon name="save" size={18} /> {editingExp ? 'æ›´æ–°è¨˜å¸³' : 'æ–°å¢è¨˜å¸³'}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showWishModal && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-fade-in-up">
                                <h3 className="font-bold text-lg text-center mb-4 text-gray-700">æ–°å¢è³¼ç‰©ç‰©å“</h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs text-gray-500 mb-1 block">ç‰©å“åç¨±</label><input type="text" value={wishForm.name} onChange={e=>setWishForm({...wishForm, name:e.target.value})} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:border-orange-400" placeholder="ä¾‹å¦‚: æ©˜å­å·§å…‹åŠ›..." autoFocus /></div>
                                    <div>
                                        <label className="text-xs text-gray-500 mb-1 block">ç…§ç‰‡ (é»æ“Šä¸Šå‚³)</label>
                                        <div className="w-full aspect-video bg-gray-100 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center relative overflow-hidden">
                                            {wishForm.image ? <img src={wishForm.image} className="w-full h-full object-cover" /> : <div className="text-gray-400 flex flex-col items-center"><Icon name="camera" size={24} /><span className="text-xs mt-1">é¸æ“‡ç…§ç‰‡</span></div>}
                                            <input type="file" accept="image/*" onChange={handleImageUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                        </div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3 mt-6"><button onClick={() => setShowWishModal(false)} className="py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button onClick={addWishItem} className="py-3 bg-orange-400 rounded-xl font-bold text-white shadow-lg">æ–°å¢</button></div>
                            </div>
                        </div>
                    )}

                    {showMemoModal && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6">
                            <div className="bg-white w-full sm:max-w-md rounded-3xl p-6 shadow-2xl animate-fade-in-up">
                                <h3 className="font-bold text-lg mb-4 text-center text-gray-700">{memoForm.id ? 'ç·¨è¼¯ç­†è¨˜' : 'æ–°å¢ç­†è¨˜'}</h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs text-gray-500 mb-1 block">æ¨™é¡Œ</label><input type="text" value={memoForm.title} onChange={e=>setMemoForm({...memoForm, title:e.target.value})} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:border-yellow-400" placeholder="ä¾‹å¦‚: é€€ç¨…è¦å®š" autoFocus /></div>
                                    <div>
                                        <label className="text-xs text-gray-500 mb-1 block">ç…§ç‰‡ (é¸å¡«)</label>
                                        <div className="w-full h-32 bg-gray-100 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center relative overflow-hidden">
                                            {memoForm.image ? <img src={memoForm.image} className="w-full h-full object-cover" /> : <div className="text-gray-400 flex flex-col items-center"><Icon name="camera" size={24} /><span className="text-xs mt-1">é¸æ“‡ç…§ç‰‡</span></div>}
                                            <input type="file" accept="image/*" onChange={handleMemoImageUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                        </div>
                                    </div>
                                    <div><label className="text-xs text-gray-500 mb-1 block">å…§å®¹</label><textarea value={memoForm.content} onChange={e=>setMemoForm({...memoForm, content:e.target.value})} className="w-full border border-gray-200 rounded-lg p-3 h-40 outline-none focus:border-yellow-400 resize-none font-zen text-sm" placeholder="è¼¸å…¥å…§å®¹..."></textarea></div>
                                </div>
                                <div className="mt-6 flex items-center justify-between">
                                    {memoForm.id ? <button onClick={deleteMemo} className="flex items-center gap-1 text-red-400 px-4 py-3 rounded-xl hover:bg-red-50 transition-colors"><Icon name="trash-2" size={20} /> åˆªé™¤</button> : <div></div>}
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowMemoModal(false)} className="py-3 px-6 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                                        <button onClick={submitMemo} className="py-3 px-6 bg-yellow-400 rounded-xl font-bold text-white shadow-md">å„²å­˜</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [tab, setTab] = useState('home');
            const safeParse = (key, defaultVal) => {
                try { const saved = localStorage.getItem(key); 
                    if (!saved || saved === 'undefined' || saved === 'null') return defaultVal;
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(defaultVal) && !Array.isArray(parsed)) return defaultVal;
                    return parsed; 
                } catch (e) { 
                    return defaultVal; 
                }
            };
            
            const [tripData, setTripData] = useState(() => safeParse('jeju_trip_data', INITIAL_TRIP_DATA));
            const [itinerary, setItinerary] = useState(() => safeParse('jeju_iti_v13', INITIAL_ITINERARY));
            const [expenses, setExpenses] = useState(() => safeParse('jeju_exp', []));
            const [shoppingList, setShoppingList] = useState(() => safeParse('jeju_shopping', []));
            const [paymentMemos, setPaymentMemos] = useState(() => safeParse('jeju_memos_v13_4', INITIAL_MEMOS));
            const [headerImage, setHeaderImage] = useState(() => safeParse('jeju_header_img_v13_1', null));
            
            const safeSave = (key, val) => {
                try { localStorage.setItem(key, JSON.stringify(val)); } 
                catch (e) { console.error("Storage Full", e); alert("å„²å­˜ç©ºé–“å·²æ»¿ï¼Œç„¡æ³•å„²å­˜è®Šæ›´ã€‚å»ºè­°åˆªé™¤ä¸€äº›ç…§ç‰‡æˆ–åŒ¯å‡ºå‚™ä»½ã€‚"); }
            };

            useEffect(() => safeSave('jeju_trip_data', tripData), [tripData]);
            useEffect(() => safeSave('jeju_iti_v13', itinerary), [itinerary]);
            useEffect(() => safeSave('jeju_exp', expenses), [expenses]);
            useEffect(() => safeSave('jeju_shopping', shoppingList), [shoppingList]);
            useEffect(() => safeSave('jeju_memos_v13_4', paymentMemos), [paymentMemos]);
            useEffect(() => safeSave('jeju_header_img_v13_1', headerImage), [headerImage]);

            const handleExport = () => {
                const data = { tripData, itinerary, expenses, shoppingList, paymentMemos, headerImage };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `JejuTrip_Backup_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if(confirm("ç¢ºå®šè¦åŒ¯å…¥å‚™ä»½å—ï¼Ÿé€™å°‡è¦†è“‹ç›®å‰çš„è³‡æ–™ã€‚")) {
                            if(data.tripData) setTripData(data.tripData);
                            if(data.itinerary) setItinerary(data.itinerary);
                            if(data.expenses) setExpenses(data.expenses);
                            if(data.shoppingList) setShoppingList(data.shoppingList);
                            if(data.paymentMemos) setPaymentMemos(data.paymentMemos);
                            if(data.headerImage) setHeaderImage(data.headerImage);
                            alert("é‚„åŸæˆåŠŸï¼");
                        }
                    } catch (err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•é‚„åŸ"); }
                };
                reader.readAsText(file);
            };

            const tabs = [
                {id:'home',i:'home',l:'é¦–é '},
                {id:'iti',i:'calendar-days',l:'è¡Œç¨‹'},
                {id:'conv',i:'calculator',l:'åŒ¯ç‡'},
                {id:'acc',i:'wallet',l:'è¨˜å¸³'}
            ];
            
            return (
                <ErrorBoundary>
                    <div className="max-w-md mx-auto h-[100dvh] w-full bg-gray-50 flex flex-col relative overflow-hidden shadow-2xl">
                        
                        <div className="flex-1 overflow-hidden relative w-full">
                            {tab==='home'?<HomeView headerImage={headerImage} setHeaderImage={setHeaderImage} onExport={handleExport} onImport={handleImport} tripData={tripData} />:
                             tab==='iti'?<ItineraryView itineraryData={itinerary} setItineraryData={setItinerary} />:
                             tab==='conv'?<ConverterView />:
                             <AccountingView expenses={expenses} setExpenses={setExpenses} shoppingList={shoppingList} setShoppingList={setShoppingList} paymentMemos={paymentMemos} setPaymentMemos={setPaymentMemos} />}
                        </div>

                        <div className="absolute bottom-0 w-full z-40 glass-nav flex justify-around items-center pb-6 pt-3">
                            {tabs.map(t => <button key={t.id} onClick={()=>setTab(t.id)} className={`flex flex-col items-center gap-1 w-16 transition-colors ${tab===t.id?'text-orange-400':'text-gray-400'}`}><Icon name={t.i} size={24} className={tab===t.id?'stroke-2':'stroke-1'} /><span className="text-[10px] font-medium font-zen">{t.l}</span></button>)}
                        </div>
                    </div>
                </ErrorBoundary>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>